
  <!DOCTYPE html>


<html lang="en">
  
<!-- Mirrored from esphome.io/cookbook/uart_text_sensor.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 16 May 2021 03:03:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta name="description" content="Instructions for setting up a custom uart text sensor.">
<meta itemprop="name" content="Custom UART Text Sensor">
<meta itemprop="description" content="Instructions for setting up a custom uart text sensor.">
<meta itemprop="image" content="../_images/language-cpp.png">
<meta name="twitter:title" content="Custom UART Text Sensor">
<meta name="twitter:image:src" content="../_images/language-cpp.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@OttoWinter_">
<meta name="twitter:description" content="Instructions for setting up a custom uart text sensor.">
<meta property="og:title" content="Custom UART Text Sensor">
<meta property="og:image" content="../_images/language-cpp.png">
<meta property="og:type" content="website">
<meta property="og:description" content="Instructions for setting up a custom uart text sensor.">

    <title>Custom UART Text Sensor &#8212; ESPHome</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="canonical" href="uart_text_sensor.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Zemismart LED RGBW/RGBWW Downlights" href="zemismart-rgbw-downlights.html" />
    <link rel="prev" title="TEMT6000" href="temt6000.html" />
  <link rel="stylesheet" href="../_static/customf001.css?hash=f908c2b5" type="text/css" />
  <link rel="apple-touch-icon" sizes="180x180" href="../_static/apple-touch-icon.png">
  <link rel="shortcut icon" href="../_static/favicon.ico">
  <link rel="icon" type="image/png" sizes="512x512" href="../_static/favicon-512x512.png">
  <link rel="icon" type="image/png" sizes="256x256" href="../_static/favicon-256x256.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../_static/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="128x128" href="../_static/favicon-128x128.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../_static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../_static/favicon-16x16.png">
  <link rel="manifest" href="../_static/site.webmanifest">
  <link rel="mask-icon" href="../_static/safari-pinned-tab.svg" color="#646464">
  <meta name="apple-mobile-web-app-title" content="ESPHome">
  <meta name="application-name" content="ESPHome">
  <meta name="msapplication-TileColor" content="#dfdfdf">
  <meta name="msapplication-config" content="/_static/browserconfig.xml">
  <meta name="theme-color" content="#dfdfdf">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta property="og:site_name" content="ESPHome">
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index-2.html">
              <img class="logo" src="../_static/logo-text.svg" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="https://esphome.io/search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index-2.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Custom UART Text Sensor</a><ul>
<li><a class="reference internal" href="#example-usage">Example usage</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="custom-uart-text-sensor">
<h1>Custom UART Text Sensor<a class="headerlink" href="#custom-uart-text-sensor" title="Permalink to this headline">Â¶</a></h1>
<p>Lots of devices communicate using the UART protocol. If you want to read
lines from uart to a Text Sensor you can do so using this code example.</p>
<p>With this you can use automations or lambda to set switch or sensor states.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;esphome.h&quot;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">UartReadLineSensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Component</span><span class="p">,</span> <span class="k">public</span> <span class="n">UARTDevice</span><span class="p">,</span> <span class="k">public</span> <span class="n">TextSensor</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">UartReadLineSensor</span><span class="p">(</span><span class="n">UARTComponent</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span> <span class="n">UARTDevice</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// nothing to do here</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">readline</span><span class="p">(</span><span class="kt">int</span> <span class="n">readch</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rpos</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">readch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">readch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="sc">&#39;\n&#39;</span><span class="o">:</span> <span class="c1">// Ignore new-lines</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;\r&#39;</span><span class="o">:</span> <span class="c1">// Return on CR</span>
          <span class="n">rpos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
          <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Reset position index ready for next time</span>
          <span class="k">return</span> <span class="n">rpos</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="mi">-1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">readch</span><span class="p">;</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// No end of line has been found, so return -1.</span>
    <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">max_line_length</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">max_line_length</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">readline</span><span class="p">(</span><span class="n">read</span><span class="p">(),</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">max_line_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">publish_state</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>(Store this file in your configuration directory, for example <code class="docutils literal notranslate"><span class="pre">uart_read_line_sensor.h</span></code>)</p>
<p>And in YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example configuration entry</span>
<span class="nt">esphome</span><span class="p">:</span>
  <span class="nt">includes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">uart_read_line_sensor.h</span>

<span class="nt">logger</span><span class="p">:</span>
  <span class="nt">level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VERBOSE</span> <span class="c1">#makes uart stream available in esphome logstream</span>
  <span class="nt">baud_rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span> <span class="c1">#disable logging over uart</span>

<span class="nt">uart</span><span class="p">:</span>
  <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">uart_bus</span>
  <span class="nt">tx_pin</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">D0</span>
  <span class="nt">rx_pin</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">D1</span>
  <span class="nt">baud_rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">9600</span>

<span class="nt">text_sensor</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">custom</span>
  <span class="nt">lambda</span><span class="p">:</span> <span class="p p-Indicator">|-</span>
    <span class="no">auto my_custom_sensor = new UartReadLineSensor(id(uart_bus));</span>
    <span class="no">App.register_component(my_custom_sensor);</span>
    <span class="no">return {my_custom_sensor};</span>
  <span class="nt">text_sensors</span><span class="p">:</span>
    <span class="nt">id</span><span class="p">:</span> <span class="s">&quot;uart_readline&quot;</span>
</pre></div>
</div>
<section id="example-usage">
<h2>Example usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">Â¶</a></h2>
<p>Here is an example switch using the uart text sensor to set switch state.</p>
<p>Here we use interval to request status from the device. The response will be stored in uart text sensor.
Then the switch uses the text sensor state to set its own state.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">switch</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">template</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;Switch&quot;</span>
    <span class="nt">lambda</span><span class="p">:</span> <span class="p p-Indicator">|-</span>
      <span class="no">if (id(uart_readline).state == &quot;*POW=ON#&quot;) {</span>
        <span class="no">return true;</span>
      <span class="no">} else if(id(uart_readline).state == &quot;*POW=OFF#&quot;) {</span>
        <span class="no">return false;</span>
      <span class="no">} else {</span>
        <span class="no">return {};</span>
      <span class="no">}</span>
    <span class="nt">turn_on_action</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">uart.write</span><span class="p">:</span> <span class="s">&quot;\r*pow=on#\r&quot;</span>
    <span class="nt">turn_off_action</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">uart.write</span><span class="p">:</span> <span class="s">&quot;\r*pow=off#\r&quot;</span>

<span class="nt">interval</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
    <span class="nt">then</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">uart.write</span><span class="p">:</span> <span class="s">&quot;\r*pow=?#\r&quot;</span>
</pre></div>
</div>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../components/uart.html"><span class="doc">UART Bus</span></a></p></li>
<li><p><a class="reference internal" href="../custom/uart.html"><span class="doc">Custom UART Device</span></a></p></li>
<li><p><a class="reference external" href="https://github.com/esphome/esphome-docs/blob/current/cookbook/uart_text_sensor.rst">Edit this page on GitHub</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
  <div id="upgrade-footer">
    A new version has been release since you last visited this page: 1.17.2 ð
    <div class="footer-button-container">
      <div role="button" id="upgrade-footer-dismiss" class="footer-button">Dismiss</div>
      <a id="upgrade-footer-changelog" class="footer-button" href="../changelog/v1.17.0.html">View Changelog</a>  
    </div>
  </div>
  <script>
    var old = window.localStorage.getItem("version");
    if (old === null) { window.localStorage.setItem("version", "1.17");
    } else if (old !== "1.17") {
      const footerEl = document.getElementById("upgrade-footer");
      footerEl.classList.add("not-hidden");
      footerEl.addEventListener('click', function () {
        window.localStorage.setItem("version", "1.17");
        footerEl.classList.remove("not-hidden");
      });
    }
  </script>

  </body>

<!-- Mirrored from esphome.io/cookbook/uart_text_sensor.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 16 May 2021 03:03:01 GMT -->
</html>